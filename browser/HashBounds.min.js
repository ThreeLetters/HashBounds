/*
 hashbounds: A spatial partitioning system

 Author: Andrews54757
 License: AGPL-3.0 (https://github.com/ThreeLetters/HashBounds/blob/master/LICENSE)
 Source: https://github.com/ThreeLetters/HashBounds
 Build: v4.5.6
 Built on: 13/08/2018
*/

var Holder=function(a,b,c,d,e){this.PARENT=a;this.CHILDINDEX=0;null!=this.PARENT&&(this.PARENT.CHILDREN[this.PARENT.CHILDINDEX++]=this);this.MAP=[];this.POWER=d;this.LVL=e;this.LEN=0;this.X=b;this.Y=c;this.BOUNDS={x:b<<d,y:c<<d,width:1<<d,height:1<<d};this.BOUNDS.minX=this.BOUNDS.x;this.BOUNDS.minY=this.BOUNDS.y;this.BOUNDS.maxX=this.BOUNDS.x+this.BOUNDS.width;this.BOUNDS.maxY=this.BOUNDS.y+this.BOUNDS.height;this.CHILDREN=[]};Holder.prototype.add=function(){++this.LEN;null!=this.PARENT&&this.PARENT.add()};
Holder.prototype.checkIntersect=function(a,b){var c=b.x+b.width,d=a.y+a.height,e=b.y+b.height;return!(b.x>=a.x+a.width||c<=a.x||b.y>=d||e<=a.y)};
Holder.prototype.getQuad=function(a,b){if(0===this.CHILDINDEX)return-2;var c=a.minX,d=a.minY,e=a.maxX,g=a.maxY,f=b.minX,k=b.minY,n=b.maxX,p=b.maxY,m=b.y+(b.height>>1),h=b.x+(b.width>>1),l=e<=h;h=c>h;return g<=m?l?[this.CHILDREN[0]]:h?[this.CHILDREN[2]]:[this.CHILDREN[0],this.CHILDREN[2]]:d>m?l?[this.CHILDREN[1]]:h?[this.CHILDREN[3]]:[this.CHILDREN[1],this.CHILDREN[3]]:l?[this.CHILDREN[0],this.CHILDREN[1]]:h?[this.CHILDREN[2],this.CHILDREN[3]]:a.width<b.width||a.height<b.height||c>f||e<n||d>k||g<p?
[this.CHILDREN[0],this.CHILDREN[1],this.CHILDREN[2],this.CHILDREN[3]]:-1};Holder.prototype.forEachAll=function(a){if(0!==this.LEN&&(this.MAP.forEach(a),0!==this.CHILDINDEX))for(var b=0;4>b;++b)this.CHILDREN[b].forEachAll(a)};Holder.prototype.forEach=function(a,b){if(0!==this.LEN){if(!a)return this.forEachAll(b);var c=this.getQuad(a,this.BOUNDS);if(-1===c)return this.forEachAll(b);this.MAP.forEach(b);if(-2!==c)for(var d=0,e=c.length;d<e;d++)c[d].forEach(a,b)}};
Holder.prototype.every=function(a,b){if(0===this.LEN)return!0;if(!a)return this.everyAll(b);var c=this.getQuad(a,this.BOUNDS);return-1===c?this.everyAll(b):this.MAP.every(b)?-2===c?!0:c.every(function(c){return c.every(a,b)}):!1};Holder.prototype.everyAll=function(a){if(0===this.LEN)return!0;if(!this.MAP.every(a))return!1;if(0!==this.CHILDINDEX)for(var b=0;4>b;++b)if(!this.CHILDREN[b].everyAll(a))return!1;return!0};Holder.prototype.sub=function(){--this.LEN;null!=this.PARENT&&this.PARENT.sub()};
Holder.prototype["delete"]=function(a){a=this.MAP.indexOf(a);this.MAP[a]=this.MAP[this.MAP.length-1];this.MAP.pop();this.sub()};Holder.prototype.set=function(a){this.MAP.push(a);this.add()};var Grid=function(a,b,c,d,e){this.POWER=a;this.LEVEL=b;this.PREV=e;this.NEXT=null;this.QUERYID=1;this.PREV&&(this.PREV.NEXT=this);this.SIZEX=c;this.SIZEY=d;this.DATA={};this.init()};Grid.prototype.getQueryID=function(){4294967295<=this.QUERYID?this.QUERYID=1:this.QUERYID++;return this.QUERYID};
Grid.prototype.init=function(){for(var a=0;a<this.SIZEX;++a){var b=a+32767<<16;if(this.PREV)var c=(a>>1)+32767<<16;for(var d=0;d<this.SIZEY;++d){var e=d>>1,g=b|d+32767,f=null;null!==this.PREV&&(f=this.PREV.DATA[c|e+32767]);this.DATA[g]=new Holder(f,a,d,this.POWER,this.LEVEL)}}};Grid.prototype.sendCreateAt=function(a,b){for(var c=a<<this.POWER,d=b<<this.POWER,e=this;e.PREV;)e=e.PREV;e.createAt(c>>e.POWER,d>>e.POWER)};
Grid.prototype.createAt=function(a,b){var c=null;null!==this.PREV&&(c=this.PREV.DATA[(a>>1)+32767<<16|(b>>1)+32767]);this.DATA[a+32767<<16|b+32767]=new Holder(c,a,b,this.POWER,this.LEVEL);if(this.NEXT){c=a<<1;var d=b<<1;this.NEXT.createAt(c,d);this.NEXT.createAt(c,d+1);this.NEXT.createAt(c+1,d);this.NEXT.createAt(c+1,d+1)}};Grid.prototype.getKey=function(a,b){return{x:a>>this.POWER,y:b>>this.POWER}};
Grid.prototype._get=function(a,b){if(!a){for(var c in this.DATA)if(this.DATA[c]&&!b(this.DATA[c]))return!1;return!0}c=a.maxX;var d=a.maxY,e=this.getKey(a.minX,a.minY);d=this.getKey(c,d);for(var g=e.x;g<=d.x;++g)for(var f=g+32767<<16,k=e.y;k<=d.y;++k)if(c=f|k+32767,this.DATA[c]&&!b(this.DATA[c]))return!1;return!0};Grid.prototype.checkChange=function(a,b,c){return a.hash.k1.x!=b.x||a.hash.k1.y!=b.y||a.hash.k2.x!=c.x||a.hash.k2.y!=c.y};
Grid.prototype.update=function(a,b){var c=b.maxX,d=b.maxY,e=this.getKey(b.minX,b.minY);c=this.getKey(c,d);return this.checkChange(a,e,c)?(this["delete"](a),this.insert(a,b,e,c),!0):!1};Grid.prototype.insert=function(a,b,c,d){var e=b.minX,g=b.minY,f=b.maxX;b=b.maxY;c=c||this.getKey(e,g);d=d||this.getKey(f,b);a.hash.k1=c;a.hash.k2=d;for(e=c.x;e<=d.x;++e)for(g=e+32767<<16,f=c.y;f<=d.y;++f)b=g|f+32767,this.DATA[b]||this.sendCreateAt(e,f),this.DATA[b].set(a);return!0};
Grid.prototype["delete"]=function(a){var b=a.hash.k1,c=a.hash.k2,d=c.x;c=c.y;for(var e=b.x;e<=d;++e)for(var g=e+32767<<16,f=b.y;f<=c;++f)this.DATA[g|f+32767]["delete"](a)};Grid.prototype.toArray=function(a){var b=this.getQueryID(),c=[];this._get(a,function(d){d.forEach(a,function(a){a._HashCheck!=b&&(a._HashCheck=b,c.push(a))});return!0});return c};
Grid.prototype.every=function(a,b){var c=this.getQueryID();return this._get(a,function(d){return d.every(a,function(a,d){if(a._HashCheck==c)return!0;a._HashCheck=c;return b(a)})})};Grid.prototype.forEach=function(a,b){var c=this.getQueryID();this._get(a,function(d){d.forEach(a,function(a,d){a._HashCheck!=c&&(a._HashCheck=c,b(a))});return!0})};
var HashBounds=function(a,b,c,d){this.INITIAL=a;this.LVL=b;this.MAXX=c;this.MAXY=d||c;this.POWER=a;this.MAXVAL;this.LEVELS=[];this.lastid=0;this.BASE;this.createLevels();this.log2=[];this.setupLog2()};HashBounds.prototype.setupLog2=function(){var a=(1<<this.LVL)-1;this.MAXVAL=a;for(var b=0;b<a;++b)this.log2.push(Math.floor(Math.log2(b+1)))};
HashBounds.prototype.createLevels=function(){this.LEVELS=[];this.ID=Math.floor(1E5*Math.random());for(var a=this.LVL-1;0<=a;--a){var b=this.INITIAL+a,c=1<<b;this.LEVELS[a]=new Grid(b,a,Math.ceil(this.MAXX/c),Math.ceil(this.MAXY/c),a==this.LVL-1?null:this.LEVELS[a+1]);a==this.LVL-1&&(this.BASE=this.LEVELS[a])}};HashBounds.prototype.clear=function(){this.createLevels()};
HashBounds.prototype.update=function(a,b){if(!a._InHash||a._HashParent!==this.ID)return this.insert(a,b);this.convertBounds(b);var c=a._HashIndex,d=this.getLevel(a,b);return c!=d?(this.LEVELS[c]["delete"](a),this.LEVELS[d].insert(a,b),!0):this.LEVELS[d].update(a,b)};
HashBounds.prototype.getLevel=function(a,b){if(a._HashSizeX===b.width&&a._HashSizeY===b.height)return a._HashIndex;var c=Math.max(b.width,b.height)>>this.POWER;c=c>=this.MAXVAL?this.LVL-1:this.log2[c];a._HashIndex=c;a._HashSizeX=b.width;a._HashSizeY=b.height;return c};
HashBounds.prototype.insert=function(a,b){a._HashParent!==this.ID&&(a._HashID=++this.lastid,a.hash={},a._HashParent=this.ID);if(a._InHash)throw"ERR: A node cannot be already in this hash!";this.convertBounds(b);this.LEVELS[this.getLevel(a,b)].insert(a,b);a._InHash=!0};HashBounds.prototype["delete"]=function(a){if(!a._InHash||a._HashParent!==this.ID)throw"ERR: Node is not in this hash!";this.LEVELS[a._HashIndex]["delete"](a);a._InHash=!1};
HashBounds.prototype.toArray=function(a){a&&this.convertBounds(a);return this.BASE.toArray(a)};HashBounds.prototype.every=function(a,b){b?this.convertBounds(a):(b=a,a=null);return this.BASE.every(a,b)};HashBounds.prototype.forEach=function(a,b){b?this.convertBounds(a):(b=a,a=null);this.BASE.forEach(a,b)};HashBounds.prototype.mmToPS=function(a){a.x=a.minX;a.y=a.minY;a.width=a.maxX-a.minX;a.height=a.maxY-a.minY};
HashBounds.prototype.psToMM=function(a){a.minX=a.x;a.minY=a.y;a.maxX=a.x+a.width;a.maxY=a.y+a.height};HashBounds.prototype.checkBoundsMax=function(a){this.convertBounds(a);return a.maxX<this.MAXX&&a.maxY<this.MAXY};
HashBounds.prototype.truncateBounds=function(a){if(1===a.TYPE)a.x=Math.min(a.x,this.MAXX),a.y=Math.min(a.y,this.MAXX),a.x+a.width>this.MAXX&&(a.width=this.MAXX-a.x),a.y+a.height>this.MAXY&&(a.height=this.MAXY-a.y);else if(2===a.TYPE)a.minX=Math.min(a.minX,this.MAXX),a.minY=Math.min(a.minY,this.MAXY),a.maxX=Math.min(a.maxX,this.MAXX),a.maxY=Math.min(a.maxY,this.MAXY);else throw"ERR: Bound not formatted! Please make sure bounds were put through the convertBounds function";};
HashBounds.prototype.convertBounds=function(a){void 0===a.TYPE?void 0!==a.x?(this.psToMM(a),a.TYPE=1):(this.mmToPS(a),a.TYPE=2):1===a.TYPE?this.psToMM(a):2===a.TYPE&&this.mmToPS(a)};
