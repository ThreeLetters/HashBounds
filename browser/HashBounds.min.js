/*
 hashbounds: A spatial partitioning system

 Author: Andrews54757
 License: AGPL-3.0 (https://github.com/ThreeLetters/HashBounds/blob/master/LICENSE)
 Source: https://github.com/ThreeLetters/HashBounds
 Build: v4.5.7
 Built on: 04/10/2018
*/

var Holder=function(a,b,c,d,e){this.PARENT=a;this.CHILDINDEX=0;null!=this.PARENT&&(this.PARENT.CHILDREN[this.PARENT.CHILDINDEX++]=this);this.MAP=[];this.POWER=d;this.LVL=e;this.LEN=0;this.X=b;this.Y=c;this.KEY=b+32767<<16|c+32767;this.BOUNDS={x:b<<d,y:c<<d,width:1<<d,height:1<<d};this.BOUNDS.minX=this.BOUNDS.x;this.BOUNDS.minY=this.BOUNDS.y;this.BOUNDS.maxX=this.BOUNDS.x+this.BOUNDS.width;this.BOUNDS.maxY=this.BOUNDS.y+this.BOUNDS.height;this.CHILDREN=[]};
Holder.prototype.add=function(){++this.LEN;null!=this.PARENT&&this.PARENT.add()};Holder.prototype.checkIntersect=function(a,b){var c=b.x+b.width,d=a.y+a.height,e=b.y+b.height;return!(b.x>=a.x+a.width||c<=a.x||b.y>=d||e<=a.y)};
Holder.prototype.getQuad=function(a,b){if(0===this.CHILDINDEX)return-2;var c=a.minX,d=a.minY,e=a.maxX,f=a.maxY,h=b.minX,k=b.minY,l=b.maxX,g=b.maxY,n=b.y+(b.height>>1),m=b.x+(b.width>>1),p=e<=m;m=c>m;return f<=n?p?[this.CHILDREN[0]]:m?[this.CHILDREN[2]]:[this.CHILDREN[0],this.CHILDREN[2]]:d>n?p?[this.CHILDREN[1]]:m?[this.CHILDREN[3]]:[this.CHILDREN[1],this.CHILDREN[3]]:p?[this.CHILDREN[0],this.CHILDREN[1]]:m?[this.CHILDREN[2],this.CHILDREN[3]]:a.width<b.width||a.height<b.height||c>h||e<l||d>k||f<g?
[this.CHILDREN[0],this.CHILDREN[1],this.CHILDREN[2],this.CHILDREN[3]]:-1};Holder.prototype._every=function(a,b){for(var c=0;c<this.MAP.length;c++)if(this.MAP[c].hash.check!=b&&(this.MAP[c].hash.check=b,!a(this.MAP[c])))return!1;return!0};Holder.prototype.every=function(a,b,c){if(0===this.LEN)return!0;var d=this.getQuad(a,this.BOUNDS);if(-1===d)return this.everyAll(b,c);if(!this._every(b,c))return!1;if(-2===d)return!0;for(var e=0;e<d.length;e++)if(!d[e].every(a,b,c))return!1;return!0};
Holder.prototype.everyAll=function(a,b){if(0===this.LEN)return!0;if(!this._every(a,b))return!1;if(0!==this.CHILDINDEX)for(var c=0;4>c;++c)if(!this.CHILDREN[c].everyAll(a,b))return!1;return!0};Holder.prototype.sub=function(){--this.LEN;null!=this.PARENT&&this.PARENT.sub()};
Holder.prototype["delete"]=function(a,b){var c=a.hash.indexes[b];if(c!==this.MAP.length-1){var d=this.MAP[c]=this.MAP[this.MAP.length-1];d.hash.indexes[(this.X-d.hash.k1x)*(d.hash.k2y-d.hash.k1y+1)+this.Y-d.hash.k1y]=c}this.MAP.pop();this.sub()};Holder.prototype.set=function(a,b){a.hash.indexes[b]=this.MAP.length;this.MAP.push(a);this.add()};
var Grid=function(a,b,c,d,e){this.POWER=a;this.LEVEL=b;this.PREV=e;this.NEXT=null;this.QUERYID=1;this.PREV&&(this.PREV.NEXT=this);this.SIZEX=c;this.SIZEY=d;this.DATA={};this.init()};Grid.prototype.init=function(){for(var a=0;a<this.SIZEX;++a){var b=a+32767<<16;if(this.PREV)var c=(a>>1)+32767<<16;for(var d=0;d<this.SIZEY;++d){var e=d>>1,f=b|d+32767,h=null;null!==this.PREV&&(h=this.PREV.DATA[c|e+32767]);this.DATA[f]=new Holder(h,a,d,this.POWER,this.LEVEL)}}};
Grid.prototype.sendCreateAt=function(a,b){for(var c=a<<this.POWER,d=b<<this.POWER,e=this;e.PREV;)e=e.PREV;e.createAt(c>>e.POWER,d>>e.POWER)};Grid.prototype.createAt=function(a,b){var c=null;null!==this.PREV&&(c=this.PREV.DATA[(a>>1)+32767<<16|(b>>1)+32767]);this.DATA[a+32767<<16|b+32767]=new Holder(c,a,b,this.POWER,this.LEVEL);if(this.NEXT){c=a<<1;var d=b<<1;this.NEXT.createAt(c,d);this.NEXT.createAt(c,d+1);this.NEXT.createAt(c+1,d);this.NEXT.createAt(c+1,d+1)}};
Grid.prototype.getKey=function(a,b){return{x:a>>this.POWER,y:b>>this.POWER}};Grid.prototype._get=function(a,b){};Grid.prototype.checkChange=function(a,b,c,d,e){return a.hash.k1x!=b||a.hash.k1y!=c||a.hash.k2x!=d||a.hash.k2y!=e};Grid.prototype.update=function(a,b){var c=b.minX>>this.POWER,d=b.minY>>this.POWER,e=b.maxX>>this.POWER,f=b.maxY>>this.POWER;return this.checkChange(a,c,d,e,f)?(this["delete"](a),this.insert(a,b,c,d,e,f),!0):!1};
Grid.prototype.insert=function(a,b,c,d,e,f){var h=b.minX,k=b.minY,l=b.maxX;b=b.maxY;void 0===c&&(c=h>>this.POWER,d=k>>this.POWER,e=l>>this.POWER,f=b>>this.POWER);a.hash.k1x=c;a.hash.k1y=d;a.hash.k2x=e;a.hash.k2y=f;h=f-d+1;for(k=c;k<=e;++k){b=k+32767<<16;l=(k-c)*h;for(var g=d;g<=f;++g){var n=b|g+32767;this.DATA[n]||this.sendCreateAt(k,g);this.DATA[n].set(a,l+g-d)}}return!0};
Grid.prototype["delete"]=function(a){for(var b=a.hash.k1x,c=a.hash.k1y,d=a.hash.k2x,e=a.hash.k2y,f=e-c+1,h=b;h<=d;++h)for(var k=h+32767<<16,l=(h-b)*f,g=c;g<=e;++g)this.DATA[k|g+32767]["delete"](a,l+g-c)};
Grid.prototype.every=function(a,b,c){if(null===a){for(var d in this.DATA)if(this.DATA[d]&&!this.DATA[d].everyAll(b,c))return!1;return!0}for(var e=a.minY>>this.POWER,f=a.maxX>>this.POWER,h=a.maxY>>this.POWER,k=a.minX>>this.POWER;k<=f;++k)for(var l=k+32767<<16,g=e;g<=h;++g)if(d=l|g+32767,this.DATA[d]&&!this.DATA[d].every(a,b,c))return!1;return!0};
var HashBounds=function(a,b,c,d){this.INITIAL=a;this.LVL=b;this.MAXX=c;this.MAXY=d||c;this.POWER=a;this.MAXVAL;this.LEVELS=[];this.lastid=0;this.BASE;this.createLevels();this.log2;this.QUERYID=1;this.setupLog2()};HashBounds.prototype.getQueryID=function(){4294967295<=this.QUERYID?this.QUERYID=1:this.QUERYID++;return this.QUERYID};HashBounds.prototype.setupLog2=function(){var a=(1<<this.LVL)-1;this.MAXVAL=a;this.log2=new Uint8Array(a);for(var b=0;b<a;++b)this.log2[b]=Math.floor(Math.log2(b+1))};
HashBounds.prototype.createLevels=function(){this.LEVELS=[];this.ID=Math.floor(1E5*Math.random());for(var a=this.LVL-1;0<=a;--a){var b=this.INITIAL+a,c=1<<b;this.LEVELS[a]=new Grid(b,a,Math.ceil(this.MAXX/c),Math.ceil(this.MAXY/c),a==this.LVL-1?null:this.LEVELS[a+1]);a==this.LVL-1&&(this.BASE=this.LEVELS[a])}};HashBounds.prototype.clear=function(){this.createLevels()};
HashBounds.prototype.update=function(a,b){if(!a._InHash||a._HashParent!==this.ID)return this.insert(a,b);this.convertBounds(b);var c=a.hash.cachedIndex,d=this.getLevel(a,b);return c!=d?(this.LEVELS[c]["delete"](a),this.LEVELS[d].insert(a,b),!0):this.LEVELS[d].update(a,b)};
HashBounds.prototype.getLevel=function(a,b){if(a.hash.cacheWidth===b.width&&a.hash.cacheHeight===b.height)return a.hash.cachedIndex;var c=Math.max(b.width,b.height)>>this.POWER;c=c>=this.MAXVAL?this.LVL-1:this.log2[c];a.hash.cachedIndex=c;a.hash.cacheWidth=b.width;a.hash.cacheHeight=b.height;return c};
HashBounds.prototype.insert=function(a,b){if(a._HashParent!==this.ID)a.hash={k1x:0,k1y:0,k2x:0,k2y:0,indexes:[],cachedIndex:0,cacheWidth:0,cacheHeight:0,id:++this.lastid,check:0},a._HashParent=this.ID;else if(a._InHash)throw"ERR: A node cannot be already in this hash!";this.convertBounds(b);this.LEVELS[this.getLevel(a,b)].insert(a,b);a._InHash=!0};
HashBounds.prototype["delete"]=function(a){if(!a._InHash||a._HashParent!==this.ID)throw"ERR: Node is not in this hash!";this.LEVELS[a.hash.cachedIndex]["delete"](a);a._InHash=!1};HashBounds.prototype.toArray=function(a){a?this.convertBounds(a):a=null;var b=[];this.BASE.every(a,function(a){b.push(a);return!0},this.getQueryID());return b};HashBounds.prototype.every=function(a,b){b?this.convertBounds(a):(b=a,a=null);return this.BASE.every(a,b,this.getQueryID())};
HashBounds.prototype.forEach=function(a,b){b?this.convertBounds(a):(b=a,a=null);this.BASE.every(a,function(a){b(a);return!0},this.getQueryID())};HashBounds.prototype.mmToPS=function(a){a.x=a.minX;a.y=a.minY;a.width=a.maxX-a.minX;a.height=a.maxY-a.minY};HashBounds.prototype.psToMM=function(a){a.minX=a.x;a.minY=a.y;a.maxX=a.x+a.width;a.maxY=a.y+a.height};HashBounds.prototype.checkBoundsMax=function(a){this.convertBounds(a);return a.maxX<this.MAXX&&a.maxY<this.MAXY};
HashBounds.prototype.truncateBounds=function(a){if(1===a.TYPE)a.x=Math.min(a.x,this.MAXX),a.y=Math.min(a.y,this.MAXX),a.x+a.width>this.MAXX&&(a.width=this.MAXX-a.x),a.y+a.height>this.MAXY&&(a.height=this.MAXY-a.y);else if(2===a.TYPE)a.minX=Math.min(a.minX,this.MAXX),a.minY=Math.min(a.minY,this.MAXY),a.maxX=Math.min(a.maxX,this.MAXX),a.maxY=Math.min(a.maxY,this.MAXY);else throw"ERR: Bound not formatted! Please make sure bounds were put through the convertBounds function";};
HashBounds.prototype.convertBounds=function(a){void 0===a.TYPE?void 0!==a.x?(this.psToMM(a),a.TYPE=1):(this.mmToPS(a),a.TYPE=2):1===a.TYPE?this.psToMM(a):2===a.TYPE&&this.mmToPS(a)};
